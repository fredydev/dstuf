# üìñ Documentation Technique ‚Äì Azure DevOps Custom Task‚ÄØ: SnapLogic Graduation

---

## 1. Objectif du Projet

D√©velopper une t√¢che personnalis√©e Azure DevOps permettant de d√©clencher un d√©ploiement SnapLogic (API REST s√©curis√©e) dans un pipeline CI/CD, avec‚ÄØ:

- Gestion stricte des environnements (DEV, CR, PRD)
- Authentification OIDC via Service Connection Azure DevOps
- Utilisation d‚Äôun client OpenAPI g√©n√©r√© pour la communication avec SnapLogic
- Logging, polling du statut, gestion des erreurs et robustesse de la cha√Æne CI/CD

---

## 2. Architecture du Projet

```
custom-task/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ GraduationTask.ts         # Logique principale de la t√¢che
‚îÇ   ‚îú‚îÄ‚îÄ client/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/                  # Client OpenAPI g√©n√©r√© (GraduationApi, Status, etc.)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ model/
‚îÇ   ‚îú‚îÄ‚îÄ test/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ task.test.ts          # Tests unitaires
‚îÇ   ‚îú‚îÄ‚îÄ task.json                 # D√©claration de la t√¢che Azure DevOps
‚îÇ   ‚îú‚îÄ‚îÄ README.md                 # Documentation utilisateur
‚îÇ   ‚îî‚îÄ‚îÄ openapi.yaml              # Contrat OpenAPI SnapLogic
‚îú‚îÄ‚îÄ dist/                         # JS compil√© pour ex√©cution
‚îú‚îÄ‚îÄ package.json                  # D√©pendances et scripts
‚îú‚îÄ‚îÄ tsconfig.json                 # Configuration TypeScript
‚îî‚îÄ‚îÄ .eslintrc.json                # Linting
```

---

## 3. Fonctionnement de la T√¢che

### Entr√©es principales (`task.json`)

- `source`‚ÄØ: nom du projet source √† d√©ployer (ex‚ÄØ: `ipaas`)
- `destination`‚ÄØ: environnement cible (`ipaas.dev1`, `ipaas.cr1`, `ipaas.pr1`)
- `snaplogicToken`‚ÄØ: Token OIDC (inject√© par une Service Connection Azure DevOps)
- `serviceConnection`‚ÄØ: (optionnel) ID de la Service Connection utilis√©e (pour contr√¥le de coh√©rence)

**Variables pipeline utilis√©es**‚ÄØ:
- `SYSTEM_TEAMPROJECT`, `SYSTEM_TEAMFOUNDATIONCOLLECTIONURI`, `BUILD_BUILDID`, `BUILD_REQUESTEDFOREMAIL` (pour le contexte release)

### √âtapes principales

1. **R√©cup√©ration des inputs et variables**
2. **V√©rification de la coh√©rence environnementale**  
   (destination, URL et Service Connection doivent cibler le m√™me env)
3. **Initialisation du client SnapLogic (OpenAPI)**
4. **Injection du token OIDC dans le client**
5. **Appel de l‚ÄôAPI SnapLogic pour d√©clencher le d√©ploiement**
6. **Polling du statut du d√©ploiement (toutes les 3s)**
7. **Logging du statut √† chaque it√©ration (mode debug recommand√©)**
8. **Gestion des statuts de retour (success, failed, running)**
9. **Gestion des erreurs et logs d√©taill√©s**

---

## 4. S√©curit√©

- **Authentification**‚ÄØ:  
  Utilisation d‚Äôun token OIDC fourni par une Service Connection Azure DevOps de type ‚ÄúGeneric‚Äù ou ‚ÄúOIDC‚Äù.
- **S√©paration stricte des environnements**‚ÄØ:  
  La t√¢che v√©rifie que la SC, l‚ÄôURL et le param√®tre `destination` correspondent au m√™me environnement (dev, cr, prd).
- **Gestion des secrets**‚ÄØ:  
  Le token n‚Äôest jamais loggu√© en clair. Les inputs secrets sont marqu√©s `isSecret` dans `task.json`.
- **Protection contre les erreurs de configuration**‚ÄØ:  
  La t√¢che √©choue explicitement si une incoh√©rence est d√©tect√©e (ex‚ÄØ: SC prod sur env dev).

---

## 5. D√©veloppement

### Langages et outils

- TypeScript (target ES2020+)
- Node.js 16+ (ex√©cution sur agent Ubuntu-latest)
- Client OpenAPI g√©n√©r√© via‚ÄØ:
  ```sh
  npx @openapitools/openapi-generator-cli generate -i openapi.yaml -g typescript-node -o src/client --additional-properties=useSingleRequestParameter=true,typescriptThreePlus=true
  ```
- Linting via ESLint (`npm run lint`)
- Tests unitaires via Mocha/Chai (`npm test`)

### Principaux fichiers

- `GraduationTask.ts`‚ÄØ: logique de la t√¢che, gestion du polling, des erreurs, des statuts et de la s√©curit√©.
- `client/api/graduationApi.ts`‚ÄØ: client g√©n√©r√©, m√©thodes `deploy`, `getStatusById`, injection du token via `accessToken`.
- `test/task.test.ts`‚ÄØ: tests unitaires avec mocks du client g√©n√©r√©.

### Gestion des d√©pendances

- D√©pendances Node.js‚ÄØ: `azure-devops-node-api`, `azure-pipelines-task-lib`, `request`, etc.
- Toutes les d√©pendances sont list√©es dans `package.json`.

---

## 6. D√©ploiement et Packaging

### Compilation

- Compile le code TypeScript en JavaScript avant publication‚ÄØ:
  ```sh
  npm run build
  ```
- Le JS compil√© est plac√© dans `dist/`.

### Packaging

- Le package de la t√¢che doit contenir‚ÄØ:
  - JS compil√© (`dist/`)
  - `task.json`
  - `node_modules` (ou les d√©pendances n√©cessaires)
  - Client OpenAPI g√©n√©r√© (ne jamais √©diter manuellement)
- Utilisation de `tfx` pour packager et publier la t√¢che sur Azure DevOps.

### Publication

- Publier la t√¢che sur l‚Äôorganisation Azure DevOps via‚ÄØ:
  ```sh
  tfx build tasks upload --task-path .
  ```

---

## 7. Utilisation dans un pipeline Azure DevOps

### Exemple YAML

```yaml
- task: SnapLogicGraduation@1
  displayName: "D√©ploiement SnapLogic DEV"
  inputs:
    source: "ipaas"
    destination: "ipaas.dev1"
    snaplogicToken: $(dev-oidc-token)
```

- **Attention**‚ÄØ:  
  - Utiliser la SC correspondant √† l‚Äôenvironnement cible.
  - Ne jamais utiliser une SC prod sur une URL dev/cr, et inversement.

---

## 8. Tests et Qualit√©

- **Tests unitaires**‚ÄØ:  
  Couvrent les cas de succ√®s, d‚Äôerreur, de polling, de gestion des statuts et de coh√©rence des inputs.
- **Linting**‚ÄØ:  
  ESLint avec configuration stricte pour garantir la coh√©rence du code.
- **Couverture**‚ÄØ:  
  Viser >70% sur la logique m√©tier critique.

---

## 9. Gestion des environnements

- **S√©paration stricte** entre DEV, CR, PRD dans la logique de la t√¢che.
- **V√©rification automatique** de la coh√©rence entre‚ÄØ:
  - l‚ÄôURL cible,
  - la valeur de `destination`,
  - le nom de la Service Connection.
- **Fail-fast**‚ÄØ: la t√¢che √©choue imm√©diatement en cas d‚Äôincoh√©rence.

---

## 10. Logging et Debug

- Utiliser `tl.debug()` pour les logs d√©taill√©s.
- Activer le mode debug dans le pipeline pour voir les logs en temps r√©el‚ÄØ:
  - Ajouter la variable pipeline‚ÄØ: `System.Debug=true`
- Les logs de polling sont visibles √† chaque it√©ration en mode debug.

---

## 11. Maintenance et √©volution

- **Pour r√©g√©n√©rer le client OpenAPI**‚ÄØ:  
  Voir la commande en section d√©veloppement.  
  Ne jamais √©diter le code g√©n√©r√© √† la main.
- **Pour ajouter un nouvel environnement**‚ÄØ:  
  Ajouter la logique de d√©tection dans la fonction de coh√©rence.
- **Pour migrer vers une nouvelle version d‚ÄôAPI**‚ÄØ:  
  Mettre √† jour le fichier `openapi.yaml` et r√©g√©n√©rer le client.
- **Pour ajouter des tests**‚ÄØ:  
  Ajouter des cas dans `test/task.test.ts` en mockant le client g√©n√©r√©.

---

## 12. S√©curit√© et bonnes pratiques DevOps

- **Jamais de secrets en clair dans les logs ou le code.**
- **Respect des permissions minimales** sur les Service Connections.
- **Versioning s√©mantique** de la t√¢che (`task.json`).
- **Documentation** √† jour‚ÄØ: README et documentation technique.
- **Accessibilit√© et robustesse**‚ÄØ: gestion des erreurs explicites, messages clairs, respect des standards Azure DevOps.

---

## 13. Annexes

### Ressources utiles

- [Azure DevOps Custom Tasks](https://learn.microsoft.com/en-us/azure/devops/extend/develop/add-build-task)
- [OpenAPI Generator](https://openapi-generator.tech/)
- [azure-devops-node-api](https://github.com/microsoft/azure-devops-node-api)
- [azure-pipelines-task-lib](https://github.com/microsoft/azure-pipelines-task-lib)
- [ESLint](https://eslint.org/)
- [Mocha](https://mochajs.org/)
- [Chai](https://www.chaijs.com/)

---

## 14. Contact et support

Pour toute question technique, contacter‚ÄØ:  
- **Equipe DevOps**‚ÄØ: dev_sup_integration@zz.com

---

**Cette documentation est √† int√©grer dans le README du projet et √† maintenir √† jour √† chaque √©volution majeure.**
